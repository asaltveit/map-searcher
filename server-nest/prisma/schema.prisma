generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agents      Agent[]
  workflows   NewsWorkflow[]
  alerts      NewsAlert[]
  preferences UserPreference?
}

model Agent {
  id           String   @id @default(uuid())
  lettaAgentId String   @unique @map("letta_agent_id")
  userId       String   @map("user_id")
  name         String
  description  String?
  model        String   @default("openai/gpt-4o-mini")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("agents")
}

// ==================== News Workflow Models ====================

model NewsWorkflow {
  id                String         @id @default(uuid())
  userId            String         @map("user_id")
  query             String // e.g., "crime in San Francisco"
  region            String // e.g., "San Francisco, CA, USA" for geocoding context
  fromDate          DateTime       @map("from_date")
  toDate            DateTime       @map("to_date")
  maxArticles       Int            @default(20) @map("max_articles")
  status            WorkflowStatus @default(PENDING)
  articlesFound     Int            @default(0) @map("articles_found")
  articlesProcessed Int            @default(0) @map("articles_processed")
  errorCount        Int            @default(0) @map("error_count")
  errorMessage      String?        @map("error_message") @db.Text
  traceId           String?        @map("trace_id")
  lettaAgentId      String?        @map("letta_agent_id")
  startedAt         DateTime?      @map("started_at")
  completedAt       DateTime?      @map("completed_at")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  articles NewsArticle[]

  @@index([userId])
  @@index([status])
  @@map("news_workflows")
}

enum WorkflowStatus {
  PENDING
  SEARCHING
  PROCESSING
  COMPLETED
  FAILED
}

model NewsArticle {
  id          String   @id @default(uuid())
  workflowId  String?  @map("workflow_id")
  alertId     String?  @map("alert_id")
  url         String
  title       String
  author      String?
  source      String
  publishedAt DateTime @map("published_at")
  content     String?  @db.Text
  imageUrl    String?  @map("image_url")

  // AI-generated
  summary   String? @db.Text
  keyPoints Json?   @map("key_points")
  sentiment String?

  // Processing
  status ProcessingStatus @default(PENDING)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workflow  NewsWorkflow?     @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  alert     NewsAlert?        @relation(fields: [alertId], references: [id], onDelete: Cascade)
  locations ArticleLocation[]

  @@unique([workflowId, url])
  @@unique([alertId, url])
  @@index([workflowId])
  @@index([alertId])
  @@map("news_articles")
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model ArticleLocation {
  id          String       @id @default(uuid())
  articleId   String       @map("article_id")
  mention     String // Original text: "corner of 5th and Main"
  mentionType LocationType @map("mention_type")
  context     String?      @db.Text

  // Geocoded
  lat              Float?
  lng              Float?
  formattedAddress String? @map("formatted_address")
  confidence       Float?
  geocodeError     String? @map("geocode_error")

  createdAt DateTime @default(now()) @map("created_at")

  article NewsArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([lat, lng])
  @@map("article_locations")
}

enum LocationType {
  ADDRESS
  CROSS_STREET
  BUSINESS
  PARK
  LANDMARK
  CITY
  OTHER
}

// ==================== Improvement Requests (user-submitted) ====================

model Improvement {
  id        String   @id @default(uuid())
  text      String   @db.Text
  userId    String   @map("user_id") // Resolved id from middleware (X-User-Id, cookie, or "default")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([text])
  @@map("improvements")
}

// ==================== News Alerts Models ====================

model NewsAlert {
  id     String @id @default(uuid())
  userId String @map("user_id")

  // Search configuration
  query       String // e.g., "robberies"
  region      String // e.g., "Savannah, GA"
  maxArticles Int    @default(20) @map("max_articles")

  // Schedule
  frequency AlertFrequency @default(MANUAL)
  lastRunAt DateTime?      @map("last_run_at")
  nextRunAt DateTime?      @map("next_run_at")

  // Status
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  articles NewsArticle[]

  @@index([userId])
  @@index([nextRunAt, isActive])
  @@map("news_alerts")
}

enum AlertFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  MANUAL
}

// ==================== User Preferences ====================

model UserPreference {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Default map settings
  defaultLat  Float? @map("default_lat")
  defaultLng  Float? @map("default_lng")
  defaultZoom Int?   @default(10) @map("default_zoom")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}
