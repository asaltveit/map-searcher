name: Sync Postman Collection

on:
  push:
    branches: [main, develop]
    # Trigger on any push to main/develop to ensure collection stays in sync

  pull_request:
    branches: [main, develop]
    # Trigger on any PR to show what will be synced when merged

  workflow_dispatch: # Allow manual trigger

# Workflow-specific concurrency: Prevent multiple Postman syncs on same branch
# but allow Postman sync to run alongside other workflows
concurrency:
  group: postman-sync-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write # Required for committing changes back to repo
  pull-requests: write # Required for commenting on PRs

jobs:
  sync-collection:
    name: Sync OpenAPI to Postman
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need history for diff checking

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check if OpenAPI spec exists
        run: |
          if [ ! -f docs/openapi.json ]; then
            echo "‚ùå ERROR: docs/openapi.json not found in repository"
            echo "Please run 'npm run openapi:gen' and commit the file"
            exit 1
          fi
          echo "‚úÖ Using committed OpenAPI spec from docs/openapi.json"

      - name: Generate Postman collection with Portman
        run: |
          echo "üîÑ Generating Postman collection from OpenAPI spec using Portman..."
          npm run postman:gen
          echo "‚úÖ Collection generated with contract tests and auth config"

      - name: Check if collection changed
        id: check-collection
        run: |
          if git diff --quiet postman/collection.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Collection unchanged after sync"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Collection changed, will commit"
          fi

      - name: Push to Postman workspace
        if: steps.check-collection.outputs.changed == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_COLLECTION_ID: ${{ secrets.POSTMAN_COLLECTION_ID }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
        run: |
          if [ -z "$POSTMAN_API_KEY" ] || [ -z "$POSTMAN_COLLECTION_ID" ]; then
            echo "‚ùå ERROR: Postman API credentials not configured"
            echo ""
            echo "Required GitHub Secrets missing:"
            echo "  - POSTMAN_API_KEY"
            echo "  - POSTMAN_COLLECTION_ID"
            echo ""
            echo "‚öôÔ∏è  Configure at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          echo "üöÄ Pushing collection to Postman workspace..."
          echo "üìù Collection ID: $POSTMAN_COLLECTION_ID"
          npm run postman:push
          echo "‚úÖ Successfully pushed to Postman workspace!"

      - name: Sync environments to Postman workspace
        if: steps.check-collection.outputs.changed == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
          POSTMAN_ENV_LOCAL_ID: ${{ secrets.POSTMAN_ENV_LOCAL_ID }}
          POSTMAN_ENV_STAGING_ID: ${{ secrets.POSTMAN_ENV_STAGING_ID }}
          POSTMAN_ENV_PROD_ID: ${{ secrets.POSTMAN_ENV_PROD_ID }}
        run: |
          echo "üåç Syncing environments to Postman workspace..."
          npm run postman:sync:envs
          echo "‚úÖ Successfully synced environments!"

      - name: Commit updated collection
        if: steps.check-collection.outputs.changed == 'true' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Get some metrics for commit message
          OPENAPI_VERSION=$(jq -r '.info.version' docs/openapi.json)
          ENDPOINT_COUNT=$(jq '.paths | length' docs/openapi.json)

          git add postman/collection.json
          git commit -m "chore: sync Postman collection from OpenAPI spec

          - Generated with Portman from OpenAPI spec version ${OPENAPI_VERSION}
          - Total endpoints: ${ENDPOINT_COUNT}
          - Includes contract tests (status, response time, schema validation)
          - JWT authentication configured via portman-config.yml
          - Workflow run: ${{ github.run_id }}

          Auto-generated by GitHub Actions using @apideck/portman"

          # Handle race conditions: pull --rebase before push with retry
          MAX_RETRIES=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git pull --rebase origin ${{ github.ref_name }} && git push; then
              echo "‚úÖ Successfully pushed changes"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚ö†Ô∏è Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
            sleep 2
          done

          echo "‚ùå Failed to push after $MAX_RETRIES retries"
          exit 1

      - name: Comment on PR (dry-run for pull requests)
        if: steps.check-collection.outputs.changed == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const openapiSpec = JSON.parse(fs.readFileSync('docs/openapi.json', 'utf8'));
            const endpointCount = Object.keys(openapiSpec.paths).length;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üîÑ Postman Collection Sync (Portman)

            The OpenAPI specification has changed, which will regenerate the Postman collection when merged.

            **Metrics:**
            - API Version: ${openapiSpec.info.version}
            - Total Endpoints: ${endpointCount}
            - Collection will be auto-generated on merge to main

            **Generated Features (via Portman config):**
            ‚úÖ JWT authentication with token refresh
            ‚úÖ Contract tests (status codes, response times, schema validation)
            ‚úÖ Environment variable substitution
            ‚úÖ Login token extraction and storage

            **Next steps:**
            1. Merge this PR to automatically regenerate the collection
            2. Team members should \`git pull\` to get the updated collection
            3. Re-import the collection in Postman if needed`
            });

      - name: Upload collection artifact
        if: steps.check-collection.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: postman-collection
          path: postman/collection.json
          retention-days: 30
